/*!
 * phina-gl2d.js 0.1.0
 * 
 * The MIT License (MIT)
 * Copyright © 2017 pentamania
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated documentation files (the “Software”), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 * 
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
/*!
 * phigl.js 1.1.1
 * https://github.com/daishihmr/phigl.js
 *
 * The MIT License (MIT)
 * Copyright © 2016 daishihmr <daishi.hmr@gmail.com> (http://github.dev7.jp/)
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated documentation files (the “Software”), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
phina.namespace(function(){phina.define("phigl.Attribute",{gl:null,name:null,_location:null,_type:null,_ptype:null,typeByteSize:4,_normalize:null,init:function(t,i,e,r,n,s,a){if(this.gl=t,this.name=e,this._normalize=s||!1,this.size=n||1,this._location=t.getAttribLocation(i,e),this._location==-1)throw"attribute "+e+" not found";switch(t.enableVertexAttribArray(this._location),this._type=r,r){case t.FLOAT:this._ptype=t.FLOAT;break;case t.FLOAT_VEC2:this._ptype=t.FLOAT;break;case t.FLOAT_VEC3:this._ptype=t.FLOAT;break;case t.FLOAT_VEC4:this._ptype=t.FLOAT;break;case t.UNSIGNED_BYTE:this.typeByteSize=1,this._ptype=t.UNSIGNED_BYTE;break;case t.UNSIGNED_SHORT:this.typeByteSize=2,this._ptype=t.UNSIGNED_SHORT}},specify:function(t,i){var e=this.gl;return e.vertexAttribPointer(this._location,this.size,this._ptype,this._normalize,t,i),this}})}),phina.namespace(function(){phina.define("glb.Detector",{_static:{isEnable:function(){try{var t=document.createElement("canvas"),i=t.getContext("webgl")||t.getContext("experimental-webgl");return!!(window.WebGLRenderingContext&&i&&i.getShaderPrecisionFormat)}catch(t){return!1}}()}})}),phina.namespace(function(){phina.define("phigl.Drawable",{superClass:"phina.util.EventDispatcher",gl:null,extVao:null,program:null,indices:null,attributes:null,stride:0,offsets:null,uniforms:null,vbo:null,drawMode:0,vao:null,init:function(t,i){this.superInit(),this.gl=t,this.extVao=i,this.attributes=[],this.offsets=[],this.uniforms={},this.drawMode=t.TRIANGLES},setDrawMode:function(t){return this.drawMode=t,this},setProgram:function(t){return this.program=t,t.use(),this},setIndexValues:function(t){return this.indices||(this.indices=phigl.Ibo(this.gl)),this.indices.set(t),this},setIndexBuffer:function(t){return this.indices=t,this},setAttribute:function(t,i,e,r,n,s){var a=this.program.uploadAttribute(t,i,e,r,n);return n=a.size*a.typeByteSize,s=s||this.stride,this.attributes.push(a),this.offsets.push(s),this.stride+=n,this},setAttributes:function(t){t=Array.prototype.concat.apply([],arguments);for(var i=0,e=0;e<t.length;e++){var r=t[e];"string"==typeof r&&(r=this.program.getAttribute(r)),this.attributes.push(r),this.offsets.push(i),i+=4*r.size}return this.stride=i,this},setAttributeData:function(t,i){this.vbo||(this.vbo=phigl.Vbo(this.gl,i)),this.vbo.set(t),this.vbo.bind();var e=this.stride,r=this.offsets;return this.attributes.forEach(function(t,i){t.specify(e,r[i])}),phigl.Vbo.unbind(this.gl),this},setAttributeDataArray:function(t,i){this.vbo||(this.vbo=phigl.Vbo(this.gl,i)),this.vbo.setAsInterleavedArray(t),this.vbo.bind();var e=this.stride,r=this.offsets;return this.attributes.forEach(function(t,i){t.specify(e,r[i])}),phigl.Vbo.unbind(this.gl),this},setAttributeVbo:function(t){this.vbo=t,this.vbo.bind();var i=this.stride,e=this.offsets;return this.attributes.forEach(function(t,r){t.specify(i,e[r])}),phigl.Vbo.unbind(this.gl),this},createVao:function(){var t=this.gl,i=this.stride,e=this.offsets;return this.extVao||(this.extVao=phigl.Extensions.getVertexArrayObject(t)),this.vao||(this.vao=this.extVao.createVertexArrayOES()),this.extVao.bindVertexArrayOES(this.vao),this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind(),this.attributes.forEach(function(r,n){r.specify(i,e[n]),t.enableVertexAttribArray(r._location)}),this.extVao.bindVertexArrayOES(null),phigl.Ibo.unbind(t),phigl.Vbo.unbind(t),this},setUniforms:function(t){t=Array.prototype.concat.apply([],arguments);var i=this.program,e=Array.prototype.reduce.call(t,function(t,e){return t[e]=i.getUniform(e),t},{});return this.uniforms.$extend(e),this},draw:function(){var t=this.gl,i=this.extVao;if(this.program.use(),this.vao)i.bindVertexArrayOES(this.vao);else{this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind();var e=this.stride,r=this.offsets;this.attributes.forEach(function(t,i){t.specify(e,r[i])})}this.uniforms.forIn(function(t,i){i.assign()}),this.flare("predraw"),this.gl.drawElements(this.drawMode,this.indices.length,t.UNSIGNED_SHORT,0),this.flare("postdraw"),this.vao?i.bindVertexArrayOES(null):(phigl.Ibo.unbind(t),phigl.Vbo.unbind(t)),this.uniforms.forIn(function(t,i){i.reassign()})}})}),phina.namespace(function(){phina.define("phigl.Extensions",{_static:{getVertexArrayObject:function(t){return this._get(t,"OES_vertex_array_object")},getInstancedArrays:function(t){return this._get(t,"ANGLE_instanced_arrays")},_get:function(t,i){var e=t.getExtension(i);if(e)return e;throw i+" is not supported"}}})}),phina.namespace(function(){phina.define("phigl.Framebuffer",{gl:null,texture:null,_framebuffer:null,_depthRenderbuffer:null,_texture:null,init:function(t,i,e){this.gl=t,this.width=i,this.height=e,this.texture=phigl.Texture(t),this._framebuffer=t.createFramebuffer(),this._depthRenderbuffer=t.createRenderbuffer(),this._texture=this.texture._texture,t.bindFramebuffer(t.FRAMEBUFFER,this._framebuffer),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,i,e),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthRenderbuffer),t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,i,e,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this._texture,0),t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null)},bind:function(){var t=this.gl;return t.bindFramebuffer(t.FRAMEBUFFER,this._framebuffer),this},_static:{unbind:function(t){t.bindFramebuffer(t.FRAMEBUFFER,null)}}})}),phina.namespace(function(){phina.define("phigl.Ibo",{gl:null,length:0,_buffer:null,init:function(t){this.gl=t,this._buffer=t.createBuffer()},set:function(t){var i=this.gl;return i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),i.STATIC_DRAW),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),this.length=t.length,this},bind:function(){return this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._buffer),this},delete:function(){this.gl.deleteBuffer(this._buffer)},_static:{unbind:function(t){return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this}},_accessor:{value:{get:function(){return null},set:function(t){this.set(t)}}}})}),phina.namespace(function(){phina.define("phigl.ImageUtil",{init:function(){},_static:{resizePowOf2:function(t,i,e){if("string"==typeof t&&(t=phina.asset.AssetManager.get("image",t).domElement),Math.sqrt(t.width)%1==0&&Math.sqrt(t.height)%1==0)return t;var r=Math.pow(2,Math.ceil(Math.log2(t.width))),n=Math.pow(2,Math.ceil(Math.log2(t.height))),s=phina.graphics.Canvas().setSize(r,n),a=i?r:t.width,h=e?n:t.height;return s.context.drawImage(t,0,0,t.width,t.height,0,0,a,h),s}}})}),phina.namespace(function(){phina.define("phigl.InstancedDrawable",{superClass:"phigl.Drawable",instanceAttributes:null,ext:null,instanceVbo:null,instanceStride:0,instanceOffsets:null,init:function(t,i){this.superInit(t),this.ext=i,this.instanceAttributes=[],this.instanceOffsets=[]},setInstanceAttributes:function(t){t=Array.prototype.concat.apply([],arguments);for(var i=(this.gl,this.ext,0),e=0;e<t.length;e++){var r=t[e];"string"==typeof r&&(r=this.program.getAttribute(r)),this.instanceAttributes.push(r),this.instanceOffsets.push(i),i+=4*r.size}return this.instanceStride=i,this},setInstanceAttributeVbo:function(t){this.instanceVbo=t,this.instanceVbo.bind();var i=this.instanceStride,e=this.instanceOffsets;return this.instanceAttributes.forEach(function(t,r){t.specify(i,e[r])}),phigl.Vbo.unbind(this.gl),this},setInstanceAttributeData:function(t){this.instanceVbo||(this.instanceVbo=phigl.Vbo(this.gl,this.gl.DYNAMIC_DRAW)),this.instanceVbo.set(t),this.instanceVbo.bind();var i=this.instanceStride,e=this.instanceOffsets;return this.instanceAttributes.forEach(function(t,r){t.specify(i,e[r])}),phigl.Vbo.unbind(this.gl),this},setInstanceAttributeDataArray:function(t){this.instanceVbo||(this.instanceVbo=phigl.Vbo(this.gl)),this.instanceVbo.setAsInterleavedArray(t),this.instanceVbo.bind();var i=this.instanceStride,e=this.instanceOffsets;return this.instanceAttributes.forEach(function(t,r){t.specify(i,e[r])}),phigl.Vbo.unbind(this.gl),this},createVao:function(){return this},draw:function(t){var i=this.gl,e=this.ext;this.program.use(),this.indices&&this.indices.bind(),this.vbo&&this.vbo.bind();var r=this.stride,n=this.offsets;this.attributes.forEach(function(t,i){t.specify(r,n[i])}),this.instanceVbo&&this.instanceVbo.bind();var s=this.instanceStride,a=this.instanceOffsets;this.instanceAttributes.forEach(function(t,i){t.specify(s,a[i]),e.vertexAttribDivisorANGLE(t._location,1)}),this.uniforms.forIn(function(t,i){i.assign()}),this.flare("predraw"),this.ext.drawElementsInstancedANGLE(this.drawMode,this.indices.length,i.UNSIGNED_SHORT,0,t),this.flare("postdraw"),this.instanceAttributes.forEach(function(t,i){e.vertexAttribDivisorANGLE(t._location,0)}),phigl.Ibo.unbind(i),phigl.Vbo.unbind(i)}})}),phina.namespace(function(){phina.define("phigl.PostProcessing",{gl:null,drawer:null,width:0,height:0,init:function(t,i,e,r,n){this.gl=t,"string"==typeof i&&(i=phigl.PostProcessing.createProgram(t,i)),r=r||256,n=n||256,e=e||[];var s=Math.pow(2,Math.ceil(Math.log2(r))),a=Math.pow(2,Math.ceil(Math.log2(n)));this.drawer=phigl.Drawable(t).setDrawMode(t.TRIANGLE_STRIP).setProgram(i).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeData([-1,1,0,n/a,1,1,r/s,n/a,-1,-1,0,0,1,-1,r/s,0]).setUniforms(["texture","canvasSize"].concat(e)),this.width=r,this.height=n,this.sqWidth=s,this.sqHeight=a},render:function(t,i){this.gl;return this.drawer.uniforms.texture.setValue(0).setTexture(t),this.drawer.uniforms.canvasSize.value=[this.sqWidth,this.sqHeight],i&&this.setUniforms(i),this.drawer.draw(),this},setUniforms:function(t){var i=this.drawer.uniforms;t.forIn(function(t,e){i[t].value=e})},calcCoord:function(t,i){return[t/this.sqWidth,(this.height-i)/this.sqHeight]},_static:{vertexShaderSource:["attribute vec2 position;","attribute vec2 uv;","varying vec2 vUv;","void main(void) {","  vUv = uv;","  gl_Position = vec4(position, 0.0, 1.0);","}"].join("\n"),createProgram:function(t,i){var e=phigl.VertexShader(t);return e.data=this.vertexShaderSource,phigl.Program(t).attach(e).attach(i).link()}}})}),phina.namespace(function(){var t=0;phina.define("phigl.Program",{_static:{currentUsing:null},gl:null,linked:!1,_program:null,_vbo:null,_attributes:null,_uniforms:null,_shaders:null,init:function(i){this.gl=i,this._program=i.createProgram(),this._program._id=t++,this.linked=!1,this._attributes={},this._uniforms={},this._shaders=[]},attach:function(t){var i=this.gl;return"string"==typeof t&&(t=phina.asset.AssetManager.get("vertexShader",t)||phina.asset.AssetManager.get("fragmentShader",t)),t.compiled||t.compile(i),i.attachShader(this._program,t._shader),this._shaders.push(t),this},link:function(){var t=this.gl;if(t.linkProgram(this._program),t.getProgramParameter(this._program,t.LINK_STATUS)){for(var i=t.getProgramParameter(this._program,t.ACTIVE_ATTRIBUTES),e=0;e<i;e++){var r=t.getActiveAttrib(this._program,e);this.getAttribute(r.name,r.type)}for(var n=t.getProgramParameter(this._program,t.ACTIVE_UNIFORMS),e=0;e<n;e++){var s=t.getActiveUniform(this._program,e);this.getUniform(s.name,s.type)}return this.linked=!0,this}throw this.linked=!1,t.getProgramInfoLog(this._program)},uploadAttribute:function(t,i,e,r,n){return this._attributes[t]=phigl.Attribute(this.gl,this._program,t,i,e,r,n),this._attributes[t]},getAttribute:function(t,i,e,r,n){return this._attributes[t]||(this._attributes[t]=phigl.Attribute(this.gl,this._program,t,i,e,r,n)),this._attributes[t]},getUniform:function(t,i){return this._uniforms[t]||(this._uniforms[t]=phigl.Uniform(this.gl,this._program,t,i)),this._uniforms[t]},use:function(){return phigl.Program.currentUsing===this?this:(this.gl.useProgram(this._program),phigl.Program.currentUsing=this,this)},delete:function(){var t=this.gl,i=this._program;return this._shaders.forEach(function(e){t.detachShader(i,e._shader)}),this._shaders.forEach(function(i){t.deleteShader(i._shader)}),t.deleteProgram(i),this}})}),phina.namespace(function(){phina.define("phigl.Shader",{superClass:"phina.asset.File",type:null,gl:null,compiled:!1,_shader:null,init:function(){this.superInit(),this.compiled=!1},compile:function(t){if(this.gl=t,this.type=this._type(t),this._shader=t.createShader(this.type),t.shaderSource(this._shader,this.data),t.compileShader(this._shader),t.getShaderParameter(this._shader,t.COMPILE_STATUS))return this.compiled=!0,this;throw this.compiled=!1,t.getShaderInfoLog(this._shader)},_type:function(t){return 0}}),phina.define("phigl.VertexShader",{superClass:"phigl.Shader",init:function(){this.superInit()},_type:function(t){return t.VERTEX_SHADER}}),phina.asset.AssetLoader.assetLoadFunctions.vertexShader=function(t,i){var e=phigl.VertexShader();return e.load({path:i})},phina.define("phigl.FragmentShader",{superClass:"phigl.Shader",init:function(){this.superInit()},_type:function(t){return t.FRAGMENT_SHADER}}),phina.asset.AssetLoader.assetLoadFunctions.fragmentShader=function(t,i){var e=phigl.FragmentShader();return e.load({path:i})}}),phina.namespace(function(){phina.define("phigl.Texture",{gl:null,_texture:null,init:function(t,i){this.gl=t,this._texture=t.createTexture(),this.isPowerOf2=!1,i&&this.setImage(i)},setImage:function(t){var i=this.gl;return"string"==typeof t&&(t=phina.asset.AssetManager.get("image",t)),i.bindTexture(i.TEXTURE_2D,this._texture),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t.domElement),phigl.Texture.isPowOf2(t.domElement)&&(i.generateMipmap(i.TEXTURE_2D),this.isPowerOf2=!0),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.bindTexture(i.TEXTURE_2D,null),this},bind:function(t){var i=this.gl;return i.activeTexture(i["TEXTURE"+(t||0)]),i.bindTexture(i.TEXTURE_2D,this._texture),this},delete:function(){this.gl.deleteTexture(this._texture)},_static:{unbind:function(t){return t.bindTexture(t.TEXTURE_2D,null),this},isPowOf2:function(t){"string"==typeof t&&(t=phina.asset.AssetManager.get("image",t).domElement);var i=function(t){return!(t&t-1)};return i(t.width)&&i(t.height)}}})}),phina.namespace(function(){phina.define("phigl.Uniform",{gl:null,name:null,texture:null,_location:null,_value:null,_type:null,_uniformMethod:null,init:function(t,i,e,r){switch(this.gl=t,this.name=e,this._location=t.getUniformLocation(i,e),this._type=r,r){case t.FLOAT:this._uniformMethod="uniform1f";break;case t.FLOAT_VEC2:this._uniformMethod="uniform2fv";break;case t.FLOAT_VEC3:this._uniformMethod="uniform3fv";break;case t.FLOAT_VEC4:this._uniformMethod="uniform4fv";break;case t.FLOAT_MAT2:this._uniformMethod="uniformMatrix2fv";break;case t.FLOAT_MAT3:this._uniformMethod="uniformMatrix3fv";break;case t.FLOAT_MAT4:this._uniformMethod="uniformMatrix4fv";break;case t.SAMPLER_2D:this._uniformMethod="uniform1i"}},setValue:function(t){return this._value=t,this},setTexture:function(t){return this.texture=t,this},assign:function(){var t=this.gl;switch(this._type){case t.FLOAT:case t.FLOAT_VEC2:case t.FLOAT_VEC3:case t.FLOAT_VEC4:t[this._uniformMethod](this._location,this._value);break;case t.FLOAT_MAT2:case t.FLOAT_MAT3:case t.FLOAT_MAT4:t[this._uniformMethod](this._location,!1,this._value);break;case t.SAMPLER_2D:this.texture&&this.texture.bind(this._value),t[this._uniformMethod](this._location,this._value)}return this},reassign:function(){var t=this.gl;switch(this._type){case t.SAMPLER_2D:this.texture&&phigl.Texture.unbind(t)}return this},_accessor:{value:{get:function(){return this._value},set:function(t){this.setValue(t)}}}})}),phina.namespace(function(){var t=0;phina.define("phigl.Vbo",{gl:null,usage:null,_vbo:null,array:null,init:function(i,e){this.gl=i,this.usage=e||i.STATIC_DRAW,this._vbo=i.createBuffer(),this._vbo._id=t++},set:function(t){var i=this.gl;return this.array?this.array.set(t):this.array=new Float32Array(t),i.bindBuffer(i.ARRAY_BUFFER,this._vbo),i.bufferData(i.ARRAY_BUFFER,this.array,this.usage),i.bindBuffer(i.ARRAY_BUFFER,null),this},setAsInterleavedArray:function(t){for(var i=t[0].data.length/t[0].unitSize,e=[],r=0;r<i;r++)t.forEach(function(t){for(var i=0;i<t.unitSize;i++)e.push(t.data[r*t.unitSize+i])});return this.set(e)},bind:function(){var t=this.gl;return t.bindBuffer(t.ARRAY_BUFFER,this._vbo),this},delete:function(){this.gl.deleteBuffer(this._vbo)},_static:{unbind:function(t){t.bindBuffer(t.ARRAY_BUFFER,null)}}})}),phina.namespace(function(){phina.define("phina.gl2d.Camera",{position:null,vMatrix:null,pMatrix:null,vpMatrix:null,init:function(){var t=this._m4=phina.geom.MatIV();this.position=new Array(3),this.vMatrix=t.create(),this.pMatrix=t.create(),this.vpMatrix=t.create()},setPosition:function(t,i,e){return this.position[0]=t,this.position[1]=i,this.position[2]=e,this},lookAt:function(t,i,e){return this._m4.lookAt(this.position,[t,i,e],[0,1,0],this.vMatrix),this},ortho:function(t,i,e,r,n,s){return this._m4.ortho(t,i,e,r,n,s,this.pMatrix),this},calcVpMatrix:function(){return this._m4.multiply(this.pMatrix,this.vMatrix,this.vpMatrix),this},uniformValues:function(){return{vpMatrix:this.vpMatrix,cameraPosition:this.position}}})}),phina.namespace(function(){phina.define("phina.gl2d.GLContext",{_static:{_view:null,_context:null,getView:function(){return this._view||(this._view=document.createElement("canvas")),this._view},getContext:function(){return this._view||(this._view=document.createElement("canvas")),this._context||(this._context=this._view.getContext("webgl")||this._view.getContext("experimental-webgl")),this._context}}})}),phina.namespace(function(){phina.define("phina.gl2d.GLLayer",{superClass:"phina.display.Layer",renderChildBySelf:!0,gl:null,resolution:1,domElement:null,renderer:null,init:function(t){this.superInit(t);var i=this.gl=phina.gl2d.GLContext.getContext();if(!i)return void console.error("お使いのブラウザはWebGLに対応していません");this.domElement=phina.gl2d.GLContext.getView();var e=(this.width,this.height,this.domElement.width=this.width*this.resolution|0),r=this.domElement.height=this.height*this.resolution|0;i.disable(i.DEPTH_TEST),i.disable(i.CULL_FACE),i.enable(i.SCISSOR_TEST),i.scissor(0,0,e,r),i.viewport(0,0,e,r),i.enable(i.BLEND),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),i.clearColor(0,0,0,0),this.camera=phina.gl2d.Camera().setPosition(.5*e,.5*r,1).lookAt(.5*e,.5*r,0).ortho(.5*-e,.5*e,.5*-r,.5*r,0,1).calcVpMatrix();var n=this.renderer=phina.gl2d.SpriteRenderer(i);n.uniforms.vpMatrix.value=this.camera.uniformValues().vpMatrix},draw:function(t){var i=this.gl,e=this.domElement,r=this.renderer;if(!i)return phina.display.Layer.prototype.draw.apply(this,arguments);if(i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.children.length>0){for(var n=this.children.slice(),s=0,a=n.length;s<a;++s)r.render(n[s]);r.flush()}t.context.drawImage(e,0,0,e.width,e.height,0,0,this.width,this.height)}})}),/*
 * minMatrix.js
 * version 0.0.1
 * Copyright (c) doxas
 * https://wgld.org/d/library/
 */
phina.namespace(function(){function t(){var t="undefined"!=typeof Float32Array?Float32Array:Array;this._create=function(){return new t(16)},this.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},this.create=function(){return this.identity(this._create())},this.multiply=function(t,i,e){var r=t[0],n=t[1],s=t[2],a=t[3],h=t[4],o=t[5],u=t[6],l=t[7],f=t[8],c=t[9],d=t[10],p=t[11],g=t[12],_=t[13],b=t[14],m=t[15],v=i[0],E=i[1],A=i[2],x=i[3],T=i[4],R=i[5],y=i[6],M=i[7],S=i[8],F=i[9],w=i[10],U=i[11],V=i[12],L=i[13],I=i[14],D=i[15];return e[0]=v*r+E*h+A*f+x*g,e[1]=v*n+E*o+A*c+x*_,e[2]=v*s+E*u+A*d+x*b,e[3]=v*a+E*l+A*p+x*m,e[4]=T*r+R*h+y*f+M*g,e[5]=T*n+R*o+y*c+M*_,e[6]=T*s+R*u+y*d+M*b,e[7]=T*a+R*l+y*p+M*m,e[8]=S*r+F*h+w*f+U*g,e[9]=S*n+F*o+w*c+U*_,e[10]=S*s+F*u+w*d+U*b,e[11]=S*a+F*l+w*p+U*m,e[12]=V*r+L*h+I*f+D*g,e[13]=V*n+L*o+I*c+D*_,e[14]=V*s+L*u+I*d+D*b,e[15]=V*a+L*l+I*p+D*m,e},this.scale=function(t,i,e){return e[0]=t[0]*i[0],e[1]=t[1]*i[0],e[2]=t[2]*i[0],e[3]=t[3]*i[0],e[4]=t[4]*i[1],e[5]=t[5]*i[1],e[6]=t[6]*i[1],e[7]=t[7]*i[1],e[8]=t[8]*i[2],e[9]=t[9]*i[2],e[10]=t[10]*i[2],e[11]=t[11]*i[2],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},this.translate=function(t,i,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[0]*i[0]+t[4]*i[1]+t[8]*i[2]+t[12],e[13]=t[1]*i[0]+t[5]*i[1]+t[9]*i[2]+t[13],e[14]=t[2]*i[0]+t[6]*i[1]+t[10]*i[2]+t[14],e[15]=t[3]*i[0]+t[7]*i[1]+t[11]*i[2]+t[15],e},this.rotate=function(t,i,e,r){var n=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);if(!n)return null;var s=e[0],a=e[1],h=e[2];1!=n&&(n=1/n,s*=n,a*=n,h*=n);var o=Math.sin(i),u=Math.cos(i),l=1-u,f=t[0],c=t[1],d=t[2],p=t[3],g=t[4],_=t[5],b=t[6],m=t[7],v=t[8],E=t[9],A=t[10],x=t[11],T=s*s*l+u,R=a*s*l+h*o,y=h*s*l-a*o,M=s*a*l-h*o,S=a*a*l+u,F=h*a*l+s*o,w=s*h*l+a*o,U=a*h*l-s*o,V=h*h*l+u;return i?t!=r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]):r=t,r[0]=f*T+g*R+v*y,r[1]=c*T+_*R+E*y,r[2]=d*T+b*R+A*y,r[3]=p*T+m*R+x*y,r[4]=f*M+g*S+v*F,r[5]=c*M+_*S+E*F,r[6]=d*M+b*S+A*F,r[7]=p*M+m*S+x*F,r[8]=f*w+g*U+v*V,r[9]=c*w+_*U+E*V,r[10]=d*w+b*U+A*V,r[11]=p*w+m*U+x*V,r},this.lookAt=function(t,i,e,r){var n=t[0],s=t[1],a=t[2],h=e[0],o=e[1],u=e[2],l=i[0],f=i[1],c=i[2];if(n==l&&s==f&&a==c)return this.identity(r);var d,p,g,_,b,m,v,E,A,x;return v=n-i[0],E=s-i[1],A=a-i[2],x=1/Math.sqrt(v*v+E*E+A*A),v*=x,E*=x,A*=x,d=o*A-u*E,p=u*v-h*A,g=h*E-o*v,x=Math.sqrt(d*d+p*p+g*g),x?(x=1/x,d*=x,p*=x,g*=x):(d=0,p=0,g=0),_=E*g-A*p,b=A*d-v*g,m=v*p-E*d,x=Math.sqrt(_*_+b*b+m*m),x?(x=1/x,_*=x,b*=x,m*=x):(_=0,b=0,m=0),r[0]=d,r[1]=_,r[2]=v,r[3]=0,r[4]=p,r[5]=b,r[6]=E,r[7]=0,r[8]=g,r[9]=m,r[10]=A,r[11]=0,r[12]=-(d*n+p*s+g*a),r[13]=-(_*n+b*s+m*a),r[14]=-(v*n+E*s+A*a),r[15]=1,r},this.ortho=function(t,i,e,r,n,s,a){var h=i-t,o=e-r,u=s-n;return a[0]=2/h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/o,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/u,a[11]=0,a[12]=-(t+i)/h,a[13]=-(e+r)/o,a[14]=-(s+n)/u,a[15]=1,a}}phina.geom.MatIV=function(){return new t}}),phina.namespace(function(){var t=function(t){return Math.pow(2,Math.round(Math.max(t,0)).toString(2).length)};Math.log2=Math.log2||function(t){return Math.log(t)/Math.LN2};var i=function(t){this.vertices=new ArrayBuffer(t),this.float32View=new Float32Array(this.vertices),this.uint32View=new Uint32Array(this.vertices)};phina.define("phina.gl2d.SpriteRenderer",{superClass:"phigl.Drawable",fullUnitSize:0,init:function(e,r,n){this.superInit(e),this._index=0,this.drawType=e.STREAM_DRAW,this.size=n||2e3,this.sprites=[],this.groups=[];for(var s=0;s<this.size;s++)this.groups[s]={texture:null,size:0,start:0};r=r||phina.gl2d.SpriteRenderer.createProgram(e),this.setProgram(r).setUniforms("vpMatrix","texture");for(var a=[],s=0,h=0;s<this.size;s++,h+=4)a=a.concat([h,h+1,h+2,h+1,h+2,h+3]);this.setIndexValues(a);var o=[{name:"position",type:e.FLOAT,attributeSize:2,unitSize:2},{name:"uv",attributeSize:2,type:e.FLOAT,unitSize:2},{name:"color",type:e.FLOAT,attributeSize:4,unitSize:4}];o.each(function(t){this.fullUnitSize+=t.unitSize,this.setAttribute(t.name,t.type,t.attributeSize,t.normalize||!1)}.bind(this));var u=phigl.Vbo(this.gl).set(0);this.setAttributeVbo(u),this.buffers=[];for(var s=1;s<=t(this.size);s*=2){var l=4*s*this.stride;this.buffers.push(new i(l))}this.indices&&this.indices.bind()},assignSprite:function(t,i){var e=t.srcRect,r=t._image.domElement.width,n=t._image.domElement.height,s=t.origin,a=t._worldMatrix,h=t._worldAlpha,o={x:e.x/r,y:e.y/n,dx:(e.x+e.width)/r,dy:(e.y+e.height)/n},u=this.fullUnitSize,l=i*u*4,f=0,c=this.buffer.float32View,d=-s.x*t._width,p=(1-s.y)*t._height;return c[l+f]=d*a.m00+p*a.m01+a.m02,c[l+f+1]=d*a.m10+p*a.m11+a.m12,c[l+f+2]=o.x,c[l+f+3]=o.dy,c[l+f+4]=1,c[l+f+5]=1,c[l+f+6]=1,c[l+f+7]=h,f+=u,d=(1-s.x)*t._width,p=(1-s.y)*t._height,c[l+f]=d*a.m00+p*a.m01+a.m02,c[l+f+1]=d*a.m10+p*a.m11+a.m12,c[l+f+2]=o.dx,c[l+f+3]=o.dy,c[l+f+4]=1,c[l+f+5]=1,c[l+f+6]=1,c[l+f+7]=h,f+=u,d=-s.x*t._width,p=-s.y*t._height,c[l+f]=d*a.m00+p*a.m01+a.m02,c[l+f+1]=d*a.m10+p*a.m11+a.m12,c[l+f+2]=o.x,c[l+f+3]=o.y,c[l+f+4]=1,c[l+f+5]=1,c[l+f+6]=1,c[l+f+7]=h,f+=u,d=(1-s.x)*t._width,p=-s.y*t._height,c[l+f]=d*a.m00+p*a.m01+a.m02,c[l+f+1]=d*a.m10+p*a.m11+a.m12,c[l+f+2]=o.dx,c[l+f+3]=o.y,c[l+f+4]=1,c[l+f+5]=1,c[l+f+6]=1,c[l+f+7]=h,this},render:function(t){if(t.visible&&(t._calcWorldAlpha&&t._calcWorldAlpha(),!(t._worldAlpha&&t._worldAlpha<=0)))return this._index>=this.size&&this.flush(),t._calcWorldMatrix&&t._calcWorldMatrix(),t.image&&(t.image._glTexture||(t.gl=this.gl,t.image._glTexture=phigl.Texture(this.gl,t.image)),this.sprites[this._index++]=t),t.children.length>0&&t.children.forEach(function(t){this.render(t)}.bind(this)),this},flush:function(){if(0!==this._index){var i,e=this.gl,r=(this.extVao,null),n=null,s=this.groups,a=1,h=s[0],o=t(this._index),u=Math.log2(o);for(this.buffer=this.buffers[u],h.start=0,h.texture=null,i=0;i<this._index;i++){var l=this.sprites[i];n=l.image,r!==n&&(r=n,null!=h.texture&&(h.size=i-h.start,h=s[a++],h.start=i),h.texture=l.image._glTexture),this.assignSprite(l,i)}for(h.size=i-h.start,e.bindBuffer(e.ARRAY_BUFFER,this.vbo._vbo),this.vbo.array.byteLength>=this.buffer.vertices.byteLength?e.bufferSubData(e.ARRAY_BUFFER,0,this.buffer.vertices):e.bufferData(e.ARRAY_BUFFER,this.buffer.vertices,this.drawType),this.vbo.array=this.buffer.vertices,e.bindBuffer(e.ARRAY_BUFFER,null),i=0;i<a;++i){var f=s[i];this.uniforms.texture;this.uniforms.texture.setTexture(f.texture),this.uniforms.forIn(function(t,i){i.assign()}),this.flare("predraw"),e.drawElements(this.drawMode,6*f.size,e.UNSIGNED_SHORT,6*f.start*2),this.flare("postdraw")}return this._index=0,this}},_static:{vertexShaderSource:["precision highp float;","attribute vec2 position;","attribute vec2 uv;","attribute vec4 color;","uniform mat4 vpMatrix;","varying vec2 vUv;","varying vec4 vColor;","void main(void) {","  gl_Position = vpMatrix * vec4(position, 0.0, 1.0);","  vUv = uv;","  vColor = vec4(color.rgb * color.a, color.a);","}"].join("\n"),fragmentShaderSource:["precision mediump float;","uniform sampler2D texture;","varying vec2 vUv;","varying vec4 vColor;","void main(void) {","  gl_FragColor = texture2D(texture, vUv) * vColor;","}"].join("\n"),createProgram:function(t){var i=phigl.VertexShader();i.data=this.vertexShaderSource;var e=phigl.FragmentShader();return e.data=this.fragmentShaderSource,phigl.Program(t).attach(i).attach(e).link()}}})});